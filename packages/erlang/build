#!/bin/bash
set -x

export CFLAGS="-g -O2 -Wa,-mrelax-relocations=no -I/opt/mesosphere/include -I/opt/mesosphere/active/ncurses/include -I/opt/mesosphere/active/openssl/include"
export LDFLAGS="-L/opt/mesosphere/lib -L/opt/mesosphere/active/ncurses/lib -L/opt/mesosphere/active/openssl/lib -Wl,-rpath=/opt/mesosphere/active/ncurses/lib -Wl,-rpath=/opt/mesosphere/active/openssl/lib -Wl,-rpath=/opt/mesosphere/lib"
export CPPFLAGS=${CFLAGS}

pushd /pkg/src/erlang

# ERL-692
## erts: Delete fd from poll-set when closing fd_driver port
git cherry-pick --no-commit 1d1f29eb614ce75012f9136d185f4dbcccc8650b
# ERL-622
## ssl: Improve error handling
git cherry-pick --no-commit a06549fbe59333347232c56093791c0075fcd150
## ssl: Add new sender process for TLS state machine
git cherry-pick --no-commit d87ac1c55188f5ba5cdf72384125d94d42118c18
## ssl: Adopt distribution over TLS to use new sender process
git cherry-pick --no-commit 0078ebf6c5311edc1a07be71fb7a127a175a60fa
## ssl: Improve close handling
git cherry-pick --no-commit a508428df8af14437f1a4766ec68294d1d736915
## kernel: Fix net_kernel:connect_node/1 to local node
git cherry-pick --no-commit c4759bc60c8e5db27c070b9e826ddc0f9626b094

./otp_build setup -a --prefix=$PKG_PATH --with-ssl=/opt/mesosphere/active/openssl --with-termcap=/opt/mesosphere/active/ncurses --disable-hipe --enable-kernel-poll --enable-builtin-zlib
make -j$NUM_CORES
make install
popd
